import { LendingProtocol } from './lending-protocol';
import { arbitrumTokens } from 'src/tokens';
import * as common from '@protocolink/common';
import { expect } from 'chai';

describe('Test Radiant V2 LendingProtocol', function () {
  context('Test getPortfolio', function () {
    const testCases = [
      {
        chainId: common.ChainId.mainnet,
        account: '0xaF184b4cBc73A9Ca2F51c4a4d80eD67a2578E9F4',
        blockTag: 18797586,
        expected: {
          chainId: 1,
          protocolId: 'radiant-v2',
          marketId: 'mainnet',
          utilization: '0.97822902811306442548',
          healthRate: '1.06588844353662664751',
          netAPY: '-1.19664219493855548459',
          totalSupplyUSD: '11342075.4944172804881341603106315',
          totalBorrowUSD: '8649160.64068362879503470404861',
          supplies: [
            {
              token: {
                chainId: 1,
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99961',
              balance: '2042222.619374',
              apy: '0.06265524668583752455',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.78',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '5831921.954657',
            },
            {
              token: {
                chainId: 1,
                address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                decimals: 6,
                symbol: 'USDC',
                name: 'USD Coin',
              },
              price: '1.00027726',
              balance: '2222.533477',
              apy: '0.05652398165619130639',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '7894657.691217',
            },
            {
              token: {
                chainId: 1,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2242.39893',
              balance: '1103.573542689366688272',
              apy: '0.09945981063749235836',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '8206.144884311207768305',
            },
            {
              token: {
                chainId: 1,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42140.09169',
              balance: '44.04572006',
              apy: '0.00563326889771342122',
              usageAsCollateralEnabled: true,
              ltv: '0.73',
              liquidationThreshold: '0.78',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '934.88422103',
            },
            {
              token: {
                chainId: 1,
                address: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2579.31314226',
              balance: '1925.888117004630721355',
              apy: '0.00591641734410512259',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '13441.57315134992665744',
            },
            {
              token: {
                chainId: 1,
                address: '0xae78736Cd615f374D3085123A210448E74Fc6393',
                decimals: 18,
                symbol: 'rETH',
                name: 'Rocket Pool ETH',
              },
              price: '2450.18252296',
              balance: '0.087686639817703145',
              apy: '0.00933862214704218952',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '2210.188081321430521736',
            },
          ],
          borrows: [
            {
              token: {
                chainId: 1,
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99961',
              balances: ['2036566.319793'],
              apys: ['0.34885803310031651378'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '4743772.101778',
            },
            {
              token: {
                chainId: 1,
                address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                decimals: 6,
                symbol: 'USDC',
                name: 'USD Coin',
              },
              price: '1.00027726',
              balances: ['0'],
              apys: ['0.30895630613608824961'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '6451466.292218',
            },
            {
              token: {
                chainId: 1,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2242.39893',
              balances: ['2116.653363798114056777'],
              apys: ['0.58286757852021725784'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '6781.209342806900264987',
            },
            {
              token: {
                chainId: 1,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42140.09169',
              balances: ['44.30477649'],
              apys: ['0.08556795486415211131'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '255.88862263',
            },
            {
              token: {
                chainId: 1,
                address: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2579.31314226',
              balances: ['0'],
              apys: ['0.08352546390718506892'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '3954.606921120925819826',
            },
            {
              token: {
                chainId: 1,
                address: '0xae78736Cd615f374D3085123A210448E74Fc6393',
                decimals: 18,
                symbol: 'rETH',
                name: 'Rocket Pool ETH',
              },
              price: '2450.18252296',
              balances: ['0'],
              apys: ['0.1059438357261863594'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '816.842177473108670771',
            },
          ],
        },
      },
      {
        chainId: common.ChainId.arbitrum,
        account: '0xBf891E7eFCC98A8239385D3172bA10AD593c7886',
        blockTag: 181603022,
        expected: {
          chainId: 42161,
          protocolId: 'radiant-v2',
          marketId: 'arbitrum',
          utilization: '0.98950205356928238332',
          healthRate: '1.05390954284952750792',
          netAPY: '-0.2798896809346952658',
          totalSupplyUSD: '18745712.15155290873834319341322165',
          totalBorrowUSD: '14579943.36046926132249376587780609',
          supplies: [
            {
              token: arbitrumTokens.WBTC,
              price: '51901.90305733',
              balance: '12.56607912',
              apy: '0.00329485655080429019',
              usageAsCollateralEnabled: true,
              ltv: '0.7',
              liquidationThreshold: '0.75',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '1213.15696324',
            },
            {
              token: arbitrumTokens.USDT,
              price: '1.00044831',
              balance: '2389.630371',
              apy: '0.01656741828043477469',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '11711309.80949',
            },
            {
              token: arbitrumTokens['USDC.e'],
              price: '0.99996891',
              balance: '7549.389838',
              apy: '0.12021261802313353346',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '13253005.074566',
            },
            {
              token: arbitrumTokens.USDC,
              price: '0.99996891',
              balance: '257.784782',
              apy: '0.0253454348508142617',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '18829167.592933',
            },
            {
              token: arbitrumTokens.DAI,
              price: '0.99999728',
              balance: '2068.143208191812887516',
              apy: '0.04363863809636928325',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '2543064.397808403009425095',
            },
            {
              token: arbitrumTokens.ETH,
              price: '2798.05380809',
              balance: '5766.562454772185210938',
              apy: '0.01627304130582863305',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.825',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '33076.711299483669923081',
            },
            {
              token: arbitrumTokens.wstETH,
              price: '3235.7728587',
              balance: '599.359210000791196472',
              apy: '0.00529429180325262032',
              usageAsCollateralEnabled: true,
              ltv: '0.7',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '17401.178570233546964601',
            },
            {
              token: arbitrumTokens.ARB,
              price: '1.98023035',
              balance: '3383.777859676833370401',
              apy: '0.00250343930261422327',
              usageAsCollateralEnabled: true,
              ltv: '0.4',
              liquidationThreshold: '0.5',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '11799952.55543394813563525',
            },
          ],
          borrows: [
            {
              token: arbitrumTokens.WBTC,
              price: '51901.90305733',
              balances: ['0'],
              apys: ['0.04863920534640730416'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '336.10056573',
            },
            {
              token: arbitrumTokens.USDT,
              price: '1.00044831',
              balances: ['0'],
              apys: ['0.0818271308882687977'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '9786811.691516',
            },
            {
              token: arbitrumTokens['USDC.e'],
              price: '0.99996891',
              balances: ['45132.230279'],
              apys: ['0.6390026190230117073'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '12179754.081696',
            },
            {
              token: arbitrumTokens.USDC,
              price: '0.99996891',
              balances: ['0'],
              apys: ['0.07976328515371036879'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '15353014.710162',
            },
            {
              token: arbitrumTokens.DAI,
              price: '0.99999728',
              balances: ['0'],
              apys: ['0.21715260913655817229'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '2211031.648459159202928098',
            },
            {
              token: arbitrumTokens.ETH,
              price: '2798.05380809',
              balances: ['5194.615081960620450891'],
              apys: ['0.09722603980622196449'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '23017.724488909365244919',
            },
            {
              token: arbitrumTokens.wstETH,
              price: '3235.7728587',
              balances: ['0.000006709259311017'],
              apys: ['0.08285541450045965186'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '4617.248245115987576612',
            },
            {
              token: arbitrumTokens.ARB,
              price: '1.98023035',
              balances: ['0'],
              apys: ['0.05630361856540085611'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '2154501.519923587322993773',
            },
          ],
        },
      },
    ];

    testCases.forEach(({ chainId, account, blockTag, expected }) => {
      it(`${common.toNetworkId(chainId)} market`, async function () {
        const protocol = new LendingProtocol(chainId);
        protocol.setBlockTag(blockTag);
        const portfolio = await protocol.getPortfolio(account);
        expect(JSON.stringify(portfolio)).to.eq(JSON.stringify(expected));
      });
    });
  });
});
